import{a as O,b as m}from"./chunk-PZWUPUS2.js";import"./chunk-HKUNN5OK.js";import{H as g,T as v,V as _,ba as P,ea as f,ia as S,s as C,x as z,y as h}from"./chunk-6FL7R2MJ.js";import{f as D}from"./chunk-EQDQRRRY.js";var b=.5,E=0,p=0,R=0,q=0,G=-1,V=1;function F(c,t){c.color?c.color.value=t:c.color={value:t}}var x=class{constructor(t,i,n,o,d){this.emitters=i,this.container=n,this._destroy=()=>{this._mutationObserver?.disconnect(),this._mutationObserver=void 0,this._resizeObserver?.disconnect(),this._resizeObserver=void 0,this.emitters.removeEmitter(this),this._engine.dispatchEvent("emitterDestroyed",{container:this.container,data:{emitter:this}})},this._prepareToDie=()=>{if(this._paused)return;let s=this.options.life?.duration!==void 0?h(this.options.life.duration):void 0;this.container.retina.reduceFactor&&(this._lifeCount>0||this._immortal)&&s!==void 0&&s>0&&(this._duration=s*1e3)},this._setColorAnimation=(s,u,y,I=V)=>{let w=this.container;if(!s.enable)return u;let A=z(s.offset),L=h(this.options.rate.delay),B=L*1e3/w.retina.reduceFactor,T=0,M=h(s.speed??T);return(u+M*w.fpsLimit/B+A*I)%y},this._engine=t,this._currentDuration=0,this._currentEmitDelay=0,this._currentSpawnDelay=0,this._initialPosition=d,o instanceof m?this.options=o:(this.options=new m,this.options.load(o)),this._spawnDelay=h(this.options.life.delay??E)*1e3/this.container.retina.reduceFactor,this.position=this._initialPosition??this._calcPosition(),this.name=this.options.name,this.fill=this.options.fill,this._firstSpawn=!this.options.life.wait,this._startParticlesAdded=!1;let a=_({},this.options.particles);if(a??={},a.move??={},a.move.direction??=this.options.direction,this.options.spawnColor&&(this.spawnColor=S(this.options.spawnColor)),this._paused=!this.options.autoPlay,this._particlesOptions=a,this._size=this._calcSize(),this.size=f(this._size,this.container.canvas.size),this._lifeCount=this.options.life.count??G,this._immortal=this._lifeCount<=p,this.options.domId){let s=document.getElementById(this.options.domId);s&&(this._mutationObserver=new MutationObserver(()=>{this.resize()}),this._resizeObserver=new ResizeObserver(()=>{this.resize()}),this._mutationObserver.observe(s,{attributes:!0,attributeFilter:["style","width","height"]}),this._resizeObserver.observe(s))}let e=this.options.shape,r=this._engine.emitterShapeManager?.getShapeGenerator(e.type);r&&(this._shape=r.generate(this.position,this.size,this.fill,e.options)),this._engine.dispatchEvent("emitterCreated",{container:n,data:{emitter:this}}),this.play()}externalPause(){this._paused=!0,this.pause()}externalPlay(){this._paused=!1,this.play()}init(){return D(this,null,function*(){yield this._shape?.init()})}pause(){this._paused||delete this._emitDelay}play(){if(!this._paused&&this.container.retina.reduceFactor&&(this._lifeCount>p||this._immortal||!this.options.life.count)&&(this._firstSpawn||this._currentSpawnDelay>=(this._spawnDelay??R))){if(this._emitDelay===void 0){let t=h(this.options.rate.delay);this._emitDelay=t*1e3/this.container.retina.reduceFactor}(this._lifeCount>p||this._immortal)&&this._prepareToDie()}}resize(){let t=this._initialPosition;this.position=t&&v(t,this.container.canvas.size,C.origin)?t:this._calcPosition(),this._size=this._calcSize(),this.size=f(this._size,this.container.canvas.size),this._shape?.resize(this.position,this.size)}update(t){this._paused||(this._firstSpawn&&(this._firstSpawn=!1,this._currentSpawnDelay=this._spawnDelay??R,this._currentEmitDelay=this._emitDelay??q),this._startParticlesAdded||(this._startParticlesAdded=!0,this._emitParticles(this.options.startCount)),this._duration!==void 0&&(this._currentDuration+=t.value,this._currentDuration>=this._duration&&(this.pause(),this._spawnDelay!==void 0&&delete this._spawnDelay,this._immortal||this._lifeCount--,this._lifeCount>p||this._immortal?(this.position=this._calcPosition(),this._shape?.resize(this.position,this.size),this._spawnDelay=h(this.options.life.delay??E)*1e3/this.container.retina.reduceFactor):this._destroy(),this._currentDuration-=this._duration,delete this._duration)),this._spawnDelay!==void 0&&(this._currentSpawnDelay+=t.value,this._currentSpawnDelay>=this._spawnDelay&&(this._engine.dispatchEvent("emitterPlay",{container:this.container}),this.play(),this._currentSpawnDelay-=this._currentSpawnDelay,delete this._spawnDelay)),this._emitDelay!==void 0&&(this._currentEmitDelay+=t.value,this._currentEmitDelay>=this._emitDelay&&(this._emit(),this._currentEmitDelay-=this._emitDelay)))}_calcPosition(){if(this.options.domId){let t=document.getElementById(this.options.domId);if(t){let i=t.getBoundingClientRect(),n=this.container.retina.pixelRatio;return{x:(i.x+i.width*b)*n,y:(i.y+i.height*b)*n}}}return g({size:this.container.canvas.size,position:this.options.position})}_calcSize(){let t=this.container;if(this.options.domId){let i=document.getElementById(this.options.domId);if(i){let n=i.getBoundingClientRect();return{width:n.width*t.retina.pixelRatio,height:n.height*t.retina.pixelRatio,mode:"precise"}}}return this.options.size??(()=>{let i=new O;return i.load({height:0,mode:"percent",width:0}),i})()}_emit(){if(this._paused)return;let t=h(this.options.rate.quantity);this._emitParticles(t)}_emitParticles(t){let i=P(this._particlesOptions);for(let n=0;n<t;n++){let o=_({},i);if(this.spawnColor){let e=this.options.spawnColor?.animation;if(e){let r={h:360,s:100,l:100},s=3.6;this.spawnColor.h=this._setColorAnimation(e.h,this.spawnColor.h,r.h,s),this.spawnColor.s=this._setColorAnimation(e.s,this.spawnColor.s,r.s),this.spawnColor.l=this._setColorAnimation(e.l,this.spawnColor.l,r.l)}F(o,this.spawnColor)}let d=this.options.shape,a=this.position;if(this._shape){let e=this._shape.randomPosition();if(e){a=e.position;let r=d.replace;r.color&&e.color&&F(o,e.color),r.opacity&&(o.opacity?o.opacity.value=e.opacity:o.opacity={value:e.opacity})}else a=null}a&&this.container.particles.addParticle(a,o)}}};export{x as EmitterInstance};
